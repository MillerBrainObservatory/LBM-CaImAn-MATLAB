
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Segmentation and Deconvolution &#8212; caiman_matlab  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css?v=5c84f910" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=ffc8af2d"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/segmentation';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Axial-Offset Correction" href="offset_correction.html" />
    <link rel="prev" title="Pre-Processing" href="pre_processing.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/favicon.ico" class="logo__image only-light" alt="caiman_matlab  documentation - Home"/>
    <script>document.write(`<img src="../_static/favicon.ico" class="logo__image only-dark" alt="caiman_matlab  documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started/index.html">
                        First Steps
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://mbo.rockefeller.edu">
                    MBO
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started/index.html">
                        First Steps
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://mbo.rockefeller.edu">
                    MBO
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="pre_processing.html">Pre_processing</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="offset_correction.html">Axial Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="tips_tricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Segmentation...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="segmentation-and-deconvolution">
<span id="segmentation-deconvolution"></span><h1>Segmentation and Deconvolution<a class="headerlink" href="#segmentation-and-deconvolution" title="Link to this heading">#</a></h1>
<a class=""
               data-lightbox="group-default"
               href="../_images/neuron_to_neuron_correlations1.png"
               title=""
               data-title=""
               
               ><img src="../_images/neuron_to_neuron_correlations1.png"
                     class=""
                     width="600"
                     height="auto"
                     alt=""/>
                </a><section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>The flourescence of the proteins in our neurons is <strong>correlated</strong> with how active the neuron is.
Turning this flourescence into “spikes” relies on several operations:</p>
<ul class="simple">
<li><p>Use <cite>matfile</cite> to load parameters of the motion-corrected movie without loading the entire movie into memory.</p></li>
<li><p>Set parameters for CNMF.</p></li>
<li><p>Perform patched, piecewise, volumetric CNMF.</p></li>
<li><p>Save outputs containing both neuropil and accepted/rejected components.</p></li>
</ul>
<p>segmentPlane.m
- construct_patches.m (caiman)
- run_CNMF_patches.m (caiman)
- classify_components.m (caiman)
- compute_event_exceptionality (caiman)
- update_temporal_components (caiman)
- detrend_df_f (caiman - modified)
- AtoAc</p>
<p>Dependencies: CaImAn_Utilities</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>No time threshold is used for component validation.</p>
</div>
</section>
<section id="function-usage">
<h2>Function Usage<a class="headerlink" href="#function-usage" title="Link to this heading">#</a></h2>
<section id="segmentplane">
<h3>segmentPlane<a class="headerlink" href="#segmentplane" title="Link to this heading">#</a></h3>
<p><a class="reference internal" href="#segmentplane"><span class="std std-ref">segmentPlane</span></a> contains the bulk of the computational complexity in this pipeline and will take significantly longer than the previous steps.</p>
<p>Inputs to <a class="reference internal" href="#segmentplane"><span class="std std-ref">segmentPlane</span></a> are similar to those seen previously. Most importantly:</p>
<ul>
<li><p>data_path: full path to motion-corrected <cite>.mat</cite> files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="n">should</span> <span class="n">contain</span> <span class="n">a</span> <span class="n">single</span> <span class="o">.</span><span class="n">mat</span> <span class="n">file</span> <span class="k">for</span> <span class="o">**</span><span class="n">each</span> <span class="mi">3</span><span class="n">D</span> <span class="n">planar</span> <span class="n">time</span><span class="o">-</span><span class="n">series</span><span class="o">**</span>

<span class="n">The</span> <span class="n">pipeline</span> <span class="n">forces</span> <span class="n">filenames</span> <span class="n">to</span> <span class="n">contain</span> <span class="n">_plane_N</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">isolate</span> <span class="n">only</span> <span class="n">motion</span><span class="o">-</span><span class="n">corrected</span>
<span class="n">mat</span> <span class="n">files</span> <span class="k">for</span> <span class="n">this</span> <span class="n">session</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>save_path: full path to a folder where you would like to save the neuron/neuropil components and traces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">This</span> <span class="n">will</span><span class="p">,</span> <span class="k">as</span> <span class="n">of</span> <span class="n">v0</span><span class="mf">.2.0</span><span class="p">,</span> <span class="n">overwrite</span> <span class="nb">any</span> <span class="n">previously</span> <span class="n">obtained</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">folder</span><span class="o">.</span>
</pre></div>
</div>
</li>
</ul>
<p>When running <a class="reference internal" href="#segmentplane"><span class="std std-ref">segmentPlane</span></a>, check the command window for reports that match the number of files you expect to be processed:</p>
<div class="highlight-MATLAB notranslate"><div class="highlight"><pre><span></span><span class="n">Processing</span><span class="w"> </span><span class="s">30</span><span class="w"> </span><span class="s">files</span><span class="w"> </span><span class="s">found</span><span class="w"> </span><span class="s">in</span><span class="w"> </span><span class="s">directory</span><span class="w"> </span><span class="s">C:\Users\&lt;username&gt;\Documents\data\bi_hemisphere\registration\...</span><span class="w">  </span><span class="s">%%</span><span class="w"> </span><span class="s">our</span><span class="w"> </span><span class="s">data_path</span>
<span class="n">Beginning</span><span class="w"> </span><span class="s">calculations</span><span class="w"> </span><span class="s">for</span><span class="w"> </span><span class="s">plane</span><span class="w"> </span><span class="s">1</span><span class="w"> </span><span class="s">of</span><span class="w"> </span><span class="s">30...</span><span class="w">  </span><span class="s">%%</span><span class="w"> </span><span class="s">check</span><span class="w"> </span><span class="s">this</span><span class="w"> </span><span class="s">matches</span><span class="w"> </span><span class="s">the</span><span class="w"> </span><span class="s">number</span><span class="w"> </span><span class="s">of</span><span class="w"> </span><span class="s">Z-Planes</span><span class="w"> </span><span class="s">you</span><span class="w"> </span><span class="s">expect</span>
<span class="n">Data</span><span class="w"> </span><span class="s">loaded</span><span class="w"> </span><span class="s">in.</span><span class="w"> </span><span class="s">This</span><span class="w"> </span><span class="s">process</span><span class="w"> </span><span class="s">takes</span><span class="w"> </span><span class="s">0.024489</span><span class="w"> </span><span class="s">minutes.</span>
<span class="n">Beginning</span><span class="w"> </span><span class="s">patched,</span><span class="w"> </span><span class="s">volumetric</span><span class="w"> </span><span class="s">CNMF...</span>
</pre></div>
</div>
</section>
</section>
<section id="atoac">
<h2>AtoAc<a class="headerlink" href="#atoac" title="Link to this heading">#</a></h2>
<p>Turn the CaImAn output A (sparse, spatial footprints for entire FOV) into Ac (sparse, spatial footprints localized around each neuron).
- Standardizes the size of each neuron’s footprint to a uniform (4*tau+1, 4*tau+1) matrix, centered on the neuron’s centroid [acx x acy].</p>
<a class=""
               data-lightbox="group-default"
               href="../_images/sparse_rep1.png"
               title=""
               data-title=""
               
               ><img src="../_images/sparse_rep1.png"
                     class=""
                     width="600"
                     height="auto"
                     alt=""/>
                </a></section>
<section id="component-validation">
<h2>Component Validation<a class="headerlink" href="#component-validation" title="Link to this heading">#</a></h2>
<p>The key idea for validating our neurons is that <strong>we know how long the brightness indicating neurons activity should stay bright</strong> as a function
of the number of frames. That is, our calcium indicator (in this example: GCaMP-6s), with a rise-time of 250ms and a decay-time of 500ms = 750ms, while we
record at 4.7 frames/second = “Samples per transient=round(4.7Hz×(0.2s+0.55s))=3”</p>
<ul class="simple">
<li><p>Use the decay time (0.5s) multiplied by the number of frames to estimate the number of samples expected in the movie.</p></li>
<li><p>Calculate the likelihood of an unexpected event (e.g., a spike) and return a value metric for the quality of the components.
- Normal Cumulative Distribution function, input = -min_SNR.</p></li>
<li><p>Evaluate the likelihood of observing traces given the distribution of noise.</p></li>
</ul>
</section>
<section id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Link to this heading">#</a></h2>
<p>There are many, many parameters used in segmentation and deconvolution. Many of the parameters are sensitive to the  pixel resolution and FOV of the recording. This section discusses such parameters.
The most influencial parameters hold information about the size of neurons and dynamics of the calcium indicator in time.</p>
<section id="tau">
<h3>Tau<a class="headerlink" href="#tau" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Tau is the <cite>half-size</cite> of a neuron. If a neuron is 10 micron, tau will be a 5 micon.</p></li>
<li><p>In general, round up.</p></li>
<li><p>The kernel is fixed to have this decay and is not fit to the data.</p></li>
</ul>
</section>
<section id="merge-thresh">
<h3>merge_thresh<a class="headerlink" href="#merge-thresh" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The value of the correlation coefficient (between 0-1) at which two neurons are considered “the same neuron!”, thus merge them.</p></li>
<li><p>This correlation is done temporally.</p></li>
</ul>
</section>
<section id="exact-caiman-parameters">
<h3>Exact CaImAn Parameters<a class="headerlink" href="#exact-caiman-parameters" title="Link to this heading">#</a></h3>
<div class="highlight-MATLAB notranslate"><div class="highlight"><pre><span></span><span class="n">merge_thresh</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">;</span>
<span class="n">min_SNR</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.4</span><span class="p">;</span><span class="w"> </span><span class="c">% liberal threshold, tighten in post</span>
<span class="n">space_thresh</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span><span class="w"> </span><span class="c">% threshold for spatial components</span>
<span class="n">time_thresh</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="n">sz</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"> </span><span class="c">% IF FOOTPRINTS ARE TOO SMALL, CONSIDER sz = 0.1</span>
<span class="n">mx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ceil</span><span class="p">(</span><span class="nb">pi</span><span class="o">.*</span><span class="p">(</span><span class="mf">1.33</span><span class="o">.*</span><span class="n">tau</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">);</span>
<span class="n">mn</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">floor</span><span class="p">(</span><span class="nb">pi</span><span class="o">.*</span><span class="p">(</span><span class="n">tau</span><span class="o">.*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.^</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c">% SHRINK IF FOOTPRINTS ARE TOO SMALL</span>
<span class="n">p</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c">% order of dynamics</span>
<span class="n">sizY</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="n">patch_size</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span><span class="mi">650</span><span class="o">/</span><span class="n">pixel_resolution</span><span class="p">)</span><span class="o">.*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
<span class="n">overlap</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.*</span><span class="nb">ceil</span><span class="p">(</span><span class="mi">50</span><span class="o">./</span><span class="n">pixel_resolution</span><span class="p">);</span>
<span class="n">patches</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">construct_patches</span><span class="p">(</span><span class="n">sizY</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="k">end</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">patch_size</span><span class="p">,</span><span class="n">overlap</span><span class="p">);</span>
<span class="c">% number of components based on assumption of 9.2e4 neurons/mm^3</span>
<span class="n">K</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">ceil</span><span class="p">(</span><span class="mf">9.2e4</span><span class="o">.*</span><span class="mf">20e-9</span><span class="o">.*</span><span class="p">(</span><span class="n">pixel_resolution</span><span class="o">.*</span><span class="n">patch_size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.^</span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>merge_thresh</strong>: Checking the temporal correlation between components that overlap in space. If they have at least 1px in common and the correlation is above the merge threshold, merge the components.</p></li>
<li><p>Factorization via CNMF yields “raw” traces (“y”). These raw traces are noisy and jagged.</p></li>
<li><p>Each raw trace is deconvolved via “constrained foopsi,” which yields the decay (and for p=2, rise) coefficients (“g”) and the vector of “spiking” activity (“S”) that best explain the raw trace. S should ideally be ~90% zeros.</p></li>
<li><p>S and g are then used to produce C, which (hopefully) looks like the raw trace Y, but much cleaner and smoother. The optional output YrA is equal to Y-C, representing the original raw trace.</p></li>
</ul>
</section>
</section>
<section id="deconvolution">
<h2>Deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading">#</a></h2>
<p>TODO: put this foopsi trickyness information in “For Developers” section</p>
<p>FOOPSI (Fast OOPSI) is originally from “Fast Nonnegative Deconvolution for Spike Train Inference From Population Calcium Imaging” by Vogelstein et al. (2010).
- OASIS was introduced in “Fast Active Set Methods for Online Spike Inference from Calcium Imaging” by Friedrich &amp; Paninski (2016).
- Most of the CAIMAN-MATLAB code uses OASIS, not FOOPSI, despite some functions being named “foopsi_oasis.”</p>
<p>Branches from the main “deconvolveCa” function in MATLAB_CAIMAN:</p>
<p><strong>oasis</strong> branches: Despite some being named “foopsi_oasis,” they use OASIS math.
- foopsi_oasisAR1
- foopsi_oasisAR2
- constrained_oasisAR1
- thresholded_oasisAR1
- thresholded_oasisAR2
<strong>constrained_foopsi</strong> branch: Used if method=”constrained” and model type is not “ar1” (e.g., ar2).
- Optimization methods: CVX (external), SPGL1 (external), LARS, dual.
<strong>onnls</strong> branch: Used if method=”foopsi” or “thresholded” with model type=”exp2” or “kernel.” Based on OASIS.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="pre_processing.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Pre-Processing</p>
      </div>
    </a>
    <a class="right-next"
       href="offset_correction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Axial-Offset Correction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#function-usage">Function Usage</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentplane">segmentPlane</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atoac">AtoAc</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#component-validation">Component Validation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters">Parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tau">Tau</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-thresh">merge_thresh</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exact-caiman-parameters">Exact CaImAn Parameters</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">Deconvolution</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/segmentation.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Elizabeth R. Miller Brain Observatory (MBO) | The Rockefeller University. All Rights Reserved..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>