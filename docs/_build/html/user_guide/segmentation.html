
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Segmentation and Deconvolution &#8212; caiman_matlab  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/css/lightbox.css?v=5c84f910" />
    <link rel="stylesheet" type="text/css" href="../_static/caiman_matlab.css?v=8c8b7c0d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2/dist/js/lightbox-plus-jquery.min.js?v=ffc8af2d"></script>
    <script src="../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js?v=12818e64"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/segmentation';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Axial-Offset Correction" href="offset_correction.html" />
    <link rel="prev" title="Piecewise-Rigid Motion-Correction" href="registration.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/favicon.ico" class="logo__image only-light" alt="caiman_matlab  documentation - Home"/>
    <script>document.write(`<img src="../_static/favicon.ico" class="logo__image only-dark" alt="caiman_matlab  documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started/index.html">
                        First Steps
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://mbo.rockefeller.edu">
                    MBO
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../get_started/index.html">
                        First Steps
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/index.html">
                        API
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://mbo.rockefeller.edu">
                    MBO
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="pre_processing.html">Pre_processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="registration.html">Registration</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="offset_correction.html">Axial Alignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="tips_tricks.html">Tips and Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Segmentation...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="segmentation-and-deconvolution">
<span id="segmentation-deconvolution"></span><h1>Segmentation and Deconvolution<a class="headerlink" href="#segmentation-and-deconvolution" title="Link to this heading">#</a></h1>
<p>The flourescence of the proteins in our neurons is <strong>correlated</strong> with how active the neuron is.
Turning this flourescence into “spikes” relies on several mathmatical operations to:</p>
<ul class="simple">
<li><p>isolate neuronal activity from background activity (<a class="reference internal" href="#source-extraction"><span class="std std-ref">Source Extraction</span></a>).</p></li>
<li><p>infer the times of action potentials from the fluorescence traces (<a class="reference internal" href="#deconvolution"><span class="std std-ref">Deconvolution</span></a>).</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TERMS:</p>
<p>The term <cite>segmentation</cite> simply refers to dividing an image based on the contents of that image, in our case, based on neuron location.
The term <cite>source extraction</cite> is more an umbrella term for all of the individual processes that produce a segmented image.
The term <cite>deconvolution</cite> is a separate step applied to the resulting traces to infer spike times from flourescence values.</p>
</div>
<p>Before running segmentation, make sure you:</p>
<ul class="simple">
<li><p>Understand the parameters and how they effect the output.</p></li>
<li><p>Confirmed no stitching artifacts or bad frames.</p></li>
<li><p>Validate your movie is accurately motion corrected.</p></li>
</ul>
<a class=""
               data-lightbox="group-default"
               href="../_images/neuron_to_neuron_correlations1.png"
               title=""
               data-title=""
               
               ><img src="../_images/neuron_to_neuron_correlations1.png"
                     class=""
                     width="600"
                     height="auto"
                     alt=""/>
                </a><section id="source-extraction">
<h2>Source Extraction<a class="headerlink" href="#source-extraction" title="Link to this heading">#</a></h2>
<p><a class="reference internal" href="../api/core.html#segmentPlane" title="segmentPlane"><code class="xref mat mat-func docutils literal notranslate"><span class="pre">segmentPlane()</span></code></a> contains the bulk of the computational complexity in this pipeline and will take significantly longer than the previous steps.</p>
<p>Inputs are covered in <a class="reference internal" href="parameters.html#parameters"><span class="std std-ref">Parameters</span></a>, with a few additional parameters. To understand these parameters, you have to understand a bit about what CNMF is trying to do.
Much of work is about separating “good activity”, the flourescence changes that we can attribute to a single cell, vs “noise, which is everything else (including signal from other neurons).
To do this, we take advantage of the fact that the slow calcium signal is typically very similar between adjacent frames. See <cite>this blog post</cite> for a nice discussion on shot noise calculations and poissson processes.</p>
<p>The <em>speed of transients</em>, or the time it takes for the neuron to fully glow (rise time) and unglow (decay time), is a very important metric used to calculate several of the parameters for CNMF.</p>
<p>In particular, speed of transients relative to the frame rate can be thought of in terms of “how many frames does it take my calcium indicator to undergo a complete transients cycle”.</p>
<section id="cnmf-options">
<h3><cite>cnmf_options</cite><a class="headerlink" href="#cnmf-options" title="Link to this heading">#</a></h3>
<p>This is a structured array containing key:value pairs of all of your CNMF parameters.
See the example parameters in the LBM_demo_pipeline.</p>
<ul class="simple">
<li><p>If this parameter is not included, they will be calculated for you based on the pixel resolution, frame rate and image size in the metadata.</p></li>
<li><p>For example, <cite>Tau</cite> is a widely talked about parameter being the half-size of your neuron.</p></li>
</ul>
<p>This is calculated by default as <span class="math notranslate nohighlight">\((7.5/pixel_resolution, 7.5/pixelresolution)\)</span>.</p>
<p>There are several different thresholds, indicating correlation coefficients as barriers for whether to perform a process or not.</p>
</section>
<section id="merge-thresh">
<h3>merge_thresh<a class="headerlink" href="#merge-thresh" title="Link to this heading">#</a></h3>
<p>A correlation coefficient determining the amount of correlation between pixels in time needed to consider two neurons the same neuron.</p>
<ul class="simple">
<li><p>The lower your resolution, the more “difficult” it is for CNMF to distinguish between two tight neurons, thus use a lower merge threshold.</p></li>
<li><p>This parameter heavily effects the number of neurons processed. It’s always better to have to many neurons vs too few, as you can never get a lost neuron back, but you can invalidate neurons in post-processing.</p></li>
</ul>
</section>
<section id="min-snr">
<h3>min_SNR<a class="headerlink" href="#min-snr" title="Link to this heading">#</a></h3>
<blockquote>
<div><p>The minimum “shot noise” to calcium activity to accept a neurons initialization.</p>
</div></blockquote>
</section>
<section id="tau">
<h3>Tau<a class="headerlink" href="#tau" title="Link to this heading">#</a></h3>
<p>Half-size of your neurons.</p>
<ul class="simple">
<li><p>Tau is the <cite>half-size</cite> of a neuron. If a neuron is 10 micron, tau will be a 5 micron.</p></li>
<li><p>In general, round up.</p></li>
</ul>
</section>
<section id="p">
<h3>P<a class="headerlink" href="#p" title="Link to this heading">#</a></h3>
<p>The term autoregression indicates that it is a regression of the variable against itself. Thus, an autoregressive model of order p can be written as yt=c+ϕ1yt−1+ϕ2yt−2+⋯+ϕpyt−p+εt,</p>
<ul class="simple">
<li><p>I dont know what that means, but that’s wikipedia. P = 1 is used when you have a fast indicator, for the reasons mentioned above regarding decay time. Use p=2 for slow indicators where you only expect 1-3 frames.</p></li>
</ul>
</section>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Link to this heading">#</a></h2>
<p>Here is a look at all of the parameters you can provide to CNMF:</p>
<div class="highlight-MATLAB notranslate"><div class="highlight"><pre><span></span><span class="n">options</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">CNMFSetParms</span><span class="p">(</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;d1&#39;</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="s">&#39;d2&#39;</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="k">...</span><span class="c">                         % dimensionality of the FOV</span>
<span class="w">    </span><span class="s">&#39;deconv_method&#39;</span><span class="p">,</span><span class="s">&#39;constrained_foopsi&#39;</span><span class="p">,</span><span class="k">...</span><span class="c">    % neural activity deconvolution method</span>
<span class="w">    </span><span class="s">&#39;temporal_iter&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="k">...</span><span class="c">                       % number of block-coordinate descent steps</span>
<span class="w">    </span><span class="s">&#39;maxIter&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="k">...</span><span class="c">                            % number of NMF iterations during initialization</span>
<span class="w">    </span><span class="s">&#39;spatial_method&#39;</span><span class="p">,</span><span class="s">&#39;regularized&#39;</span><span class="p">,</span><span class="k">...</span><span class="c">          % method for updating spatial components</span>
<span class="w">    </span><span class="s">&#39;df_prctile&#39;</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="k">...</span><span class="c">                         % take the median of background fluorescence to compute baseline fluorescence</span>
<span class="w">    </span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="k">...</span><span class="c">                                   % order of AR dynamics</span>
<span class="w">    </span><span class="s">&#39;gSig&#39;</span><span class="p">,</span><span class="n">tau</span><span class="p">,</span><span class="k">...</span><span class="c">                              % half size of neuron</span>
<span class="w">    </span><span class="s">&#39;merge_thr&#39;</span><span class="p">,</span><span class="n">merge_thresh</span><span class="p">,</span><span class="k">...</span><span class="c">                % merging threshold</span>
<span class="w">    </span><span class="s">&#39;nb&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="k">...</span><span class="c">                                  % number of background components</span>
<span class="w">    </span><span class="s">&#39;gnb&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;min_SNR&#39;</span><span class="p">,</span><span class="n">min_SNR</span><span class="p">,</span><span class="k">...</span><span class="c">                       % minimum SNR threshold</span>
<span class="w">    </span><span class="s">&#39;space_thresh&#39;</span><span class="p">,</span><span class="n">space_thresh</span><span class="w"> </span><span class="p">,</span><span class="k">...</span><span class="c">            % space correlation threshold</span>
<span class="w">    </span><span class="s">&#39;decay_time&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="k">...</span><span class="c">                        % decay time of transients, GCaMP6s</span>
<span class="w">    </span><span class="s">&#39;size_thr&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sz</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;search_method&#39;</span><span class="p">,</span><span class="s">&#39;ellipse&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;min_size&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">round</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span><span class="w"> </span><span class="k">...</span><span class="c">                 % minimum size of ellipse axis (default: 3)</span>
<span class="w">    </span><span class="s">&#39;max_size&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span><span class="w"> </span><span class="k">...</span><span class="c">               % maximum size of ellipse axis (default: 8)</span>
<span class="w">    </span><span class="s">&#39;dist&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="k">...</span><span class="c">                           % expansion factor of ellipse (default: 3)</span>
<span class="w">    </span><span class="s">&#39;max_size_thr&#39;</span><span class="p">,</span><span class="n">mx</span><span class="p">,</span><span class="k">...</span><span class="c">                       % maximum size of each component in pixels (default: 300)</span>
<span class="w">    </span><span class="s">&#39;time_thresh&#39;</span><span class="p">,</span><span class="n">time_thresh</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;min_size_thr&#39;</span><span class="p">,</span><span class="n">mn</span><span class="p">,</span><span class="k">...</span><span class="c">                       % minimum size of each component in pixels (default: 9)</span>
<span class="w">    </span><span class="s">&#39;refine_flag&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;rolling_length&#39;</span><span class="p">,</span><span class="nb">ceil</span><span class="p">(</span><span class="n">FrameRate</span><span class="o">*</span><span class="mi">5</span><span class="p">),</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;fr&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">FrameRate</span><span class="w"> </span><span class="k">...</span>
<span class="p">);</span>
</pre></div>
</div>
<p>When running <a class="reference internal" href="../api/core.html#segmentPlane" title="segmentPlane"><code class="xref mat mat-func docutils literal notranslate"><span class="pre">segmentPlane()</span></code></a>, check the command window for reports that match the number of files you expect to be processed:</p>
<div class="highlight-MATLAB notranslate"><div class="highlight"><pre><span></span><span class="n">Processing</span><span class="w"> </span><span class="s">30</span><span class="w"> </span><span class="s">files</span><span class="w"> </span><span class="s">found</span><span class="w"> </span><span class="s">in</span><span class="w"> </span><span class="s">directory</span><span class="w"> </span><span class="s">C:\Users\&lt;username&gt;\Documents\data\bi_hemisphere\registration\...</span><span class="w">  </span><span class="s">%%</span><span class="w"> </span><span class="s">our</span><span class="w"> </span><span class="s">data_path</span>
<span class="n">Beginning</span><span class="w"> </span><span class="s">calculations</span><span class="w"> </span><span class="s">for</span><span class="w"> </span><span class="s">plane</span><span class="w"> </span><span class="s">1</span><span class="w"> </span><span class="s">of</span><span class="w"> </span><span class="s">30...</span><span class="w">  </span><span class="s">%%</span><span class="w"> </span><span class="s">check</span><span class="w"> </span><span class="s">this</span><span class="w"> </span><span class="s">matches</span><span class="w"> </span><span class="s">the</span><span class="w"> </span><span class="s">number</span><span class="w"> </span><span class="s">of</span><span class="w"> </span><span class="s">Z-Planes</span><span class="w"> </span><span class="s">you</span><span class="w"> </span><span class="s">expect</span>
<span class="n">Data</span><span class="w"> </span><span class="s">loaded</span><span class="w"> </span><span class="s">in.</span><span class="w"> </span><span class="s">This</span><span class="w"> </span><span class="s">process</span><span class="w"> </span><span class="s">takes</span><span class="w"> </span><span class="s">0.024489</span><span class="w"> </span><span class="s">minutes.</span>
<span class="n">Beginning</span><span class="w"> </span><span class="s">patched,</span><span class="w"> </span><span class="s">volumetric</span><span class="w"> </span><span class="s">CNMF...</span>
</pre></div>
</div>
</section>
<section id="atoac">
<h2>AtoAc<a class="headerlink" href="#atoac" title="Link to this heading">#</a></h2>
<p>Turn the CaImAn output A (sparse, spatial footprints for entire FOV) into Ac (sparse, spatial footprints localized around each neuron).
- Standardizes the size of each neuron’s footprint to a uniform (4*tau+1, 4*tau+1) matrix, centered on the neuron’s centroid [acx x acy].</p>
<a class=""
               data-lightbox="group-default"
               href="../_images/sparse_rep1.png"
               title=""
               data-title=""
               
               ><img src="../_images/sparse_rep1.png"
                     class=""
                     width="600"
                     height="auto"
                     alt=""/>
                </a></section>
<section id="component-validation">
<h2>Component Validation<a class="headerlink" href="#component-validation" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although it is important to understand the process governing validating neurons, this process is
fully performed for you with no extra steps needed.</p>
</div>
<p>The key idea for validating our neurons is that <strong>we know how long the
brightness indicating neurons activity should stay bright</strong> as a function
of the <em>number of frames</em>.</p>
<p>That is, our calcium indicator (in this example: GCaMP-6s):
- rise-time of 250ms
- decay-time of 500ms
- total transient time = 750ms
- Frame rate = 4.7 frames/second</p>
<p>4.7hz * (0.2+0.55) = 3 frames per transient.</p>
<p>And thus the general process of validating neuronal components is as follows:</p>
<ul class="simple">
<li><p>Use the decay time (0.5s) multiplied by the number of frames to estimate the number of samples expected in the movie.</p></li>
<li><p>Calculate the likelihood of an unexpected event (e.g., a spike) and return a value metric for the quality of the components.</p></li>
<li><p>Normal Cumulative Distribution function, input = -min_SNR.</p></li>
<li><p>Evaluate the likelihood of observing traces given the distribution of noise.</p></li>
</ul>
<section id="output">
<h3>Output<a class="headerlink" href="#output" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The CNMF output yields “raw” traces (“y”). These raw traces are noisy and jagged and must be denoised/deconvolved.</p></li>
<li><p>Another term for this is “detrending”, removing non-stationary variability from the signal</p></li>
<li><p>Each raw trace is deconvolved via “constrained foopsi,” which yields the decay (and for p=2, rise) coefficients (“g”) and the vector of “spiking” activity (“S”) that best explain the raw trace. S should ideally be ~90% zeros.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">S</span></code> and <code class="code docutils literal notranslate"><span class="pre">g</span></code> are then used to produce <code class="code docutils literal notranslate"><span class="pre">C</span></code> (deconvolved traces), which looks like the raw trace <code class="code docutils literal notranslate"><span class="pre">Y</span></code>, but much cleaner and smoother.</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The optional output YrA is equal to Y-C, representing the original raw trace.</p>
</div>
</section>
</section>
<section id="deconvolution">
<h2>Deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading">#</a></h2>
<p>FOOPSI (Fast OOPSI) is originally from “Fast Nonnegative Deconvolution for Spike Train Inference From Population Calcium Imaging” by Vogelstein et al. (2010).
- OASIS was introduced in “Fast Active Set Methods for Online Spike Inference from Calcium Imaging” by Friedrich &amp; Paninski (2016).
- Most of the CAIMAN-MATLAB code uses OASIS, not FOOPSI, despite some functions being named “foopsi_oasis.”</p>
<p>Branches from the main “deconvolveCa” function in MATLAB_CAIMAN:</p>
<p><strong>oasis</strong> branches: Despite some being named “foopsi_oasis,” they use OASIS math.
- foopsi_oasisAR1
- foopsi_oasisAR2
- constrained_oasisAR1
- thresholded_oasisAR1
- thresholded_oasisAR2
<strong>constrained_foopsi</strong> branch: Used if method=”constrained” and model type is not “ar1” (e.g., ar2).
- Optimization methods: CVX (external), SPGL1 (external), LARS, dual.
<strong>onnls</strong> branch: Used if method=”foopsi” or “thresholded” with model type=”exp2” or “kernel.” Based on OASIS.</p>
</section>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<p>The output of the analysis includes several key variables that describe the segmented neuronal components and their corresponding activities. Below is a description of each output variable, along with an example of how to use them and what they represent.</p>
<ol class="arabic">
<li><dl>
<dt><strong>T_all</strong>: Neuronal time-series</dt><dd><ul class="simple">
<li><p><strong>Description</strong>: <cite>T_all</cite> contains the fluorescence time-series data for each detected neuronal component. Each row corresponds to a different neuron, and each column corresponds to a different time point.</p></li>
<li><p><strong>Usage</strong>: This data can be used to analyze the temporal dynamics of neuronal activity, such as identifying patterns of activation over time.</p></li>
<li><p><strong>Example</strong>:</p></li>
</ul>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">plot</span><span class="p">(</span><span class="n">T_all</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">:));</span><span class="w"> </span><span class="c">% Plot the time-series for the first neuron</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;Time (frames)&#39;</span><span class="p">);</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Fluorescence (dF/F)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>C_all</strong>: Deconvolved neuronal activity</dt><dd><ul class="simple">
<li><p><strong>Description</strong>: <cite>C_all</cite> contains the deconvolved activity traces, which represent the estimated underlying neuronal firing rates. This data is derived from <cite>T_all</cite> through a deconvolution process that attempts to remove the effects of calcium dynamics.</p></li>
<li><p><strong>Usage</strong>: This data can be used to study the inferred spiking activity of neurons, which is often more directly related to neuronal communication than raw fluorescence data.</p></li>
<li><p><strong>Example</strong>:</p></li>
</ul>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">plot</span><span class="p">(</span><span class="n">C_all</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">:));</span><span class="w"> </span><span class="c">% Plot the deconvolved activity for the first neuron</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;Time (frames)&#39;</span><span class="p">);</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Deconvolved activity&#39;</span><span class="p">);</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>N_all</strong>: Neuronal spatial coordinates and other properties</dt><dd><ul class="simple">
<li><p><strong>Description</strong>: <cite>N_all</cite> is a matrix where each row represents a neuron, and the columns contain properties such as the neuron’s integrated fluorescence (<cite>acm</cite>), x-coordinate (<cite>acx</cite>), y-coordinate (<cite>acy</cite>), and z-coordinate (plane index).</p></li>
<li><p><strong>Usage</strong>: This data can be used to analyze the spatial distribution of neurons within the imaging field and correlate spatial properties with functional data.</p></li>
<li><p><strong>Example</strong>:</p></li>
</ul>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">scatter</span><span class="p">(</span><span class="n">N_all</span><span class="p">(:,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">N_all</span><span class="p">(:,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span><span class="w"> </span><span class="c">% Plot the spatial distribution of neurons in the xy-plane</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x-coordinate&#39;</span><span class="p">);</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y-coordinate&#39;</span><span class="p">);</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Ac_keep</strong>: Neuronal footprints</dt><dd><ul class="simple">
<li><p><cite>Ac_keep</cite> contains the spatial footprints of the detected neurons. Each neuron is represented by a 2D matrix showing its spatial extent and intensity within the imaging field.</p></li>
<li><p>This data can be used to visualize the spatial arrangement and morphology of neuronal components.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">imagesc</span><span class="p">(</span><span class="n">Ac_keep</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"> </span><span class="c">% Display the spatial footprint of the first neuron</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Neuron 1 Footprint&#39;</span><span class="p">);</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><dl class="simple">
<dt><strong>Cn</strong>: Correlation image</dt><dd><ul class="simple">
<li><p><strong>Description</strong>: <cite>Cn</cite> is a 2D image showing the correlation of each pixel’s time-series with its neighboring pixels, highlighting areas of correlated activity.</p></li>
<li><p><strong>Usage</strong>: This image can be used to identify regions of interest and assess the overall quality of the motion correction and segmentation process.</p></li>
<li><p><strong>Example</strong>:</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">imagesc</span><span class="p">(</span><span class="n">Cn</span><span class="p">);</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Correlation Image&#39;</span><span class="p">);</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><dl class="simple">
<dt><strong>Ym</strong>: Mean image</dt><dd><ul class="simple">
<li><p><cite>Ym</cite> is a 2D image representing the average fluorescence intensity across all time points, providing a baseline view of the imaging field.</p></li>
<li><p>This image can be used to visualize the general structure and intensity distribution within the imaging field.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">imagesc</span><span class="p">(</span><span class="n">Ym</span><span class="p">);</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Mean Image&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>With these variables, plot some images:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Plot the time-series for the first neuron</span>
<span class="nb">figure</span><span class="p">;</span>
<span class="nb">plot</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">T_keep</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">:));</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Neuronal Time-series for Neuron 1&#39;</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;Time (frames)&#39;</span><span class="p">);</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Fluorescence (dF/F)&#39;</span><span class="p">);</span>

<span class="c">% Display the spatial footprint of the first neuron</span>
<span class="nb">figure</span><span class="p">;</span>
<span class="nb">imagesc</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">Ac_keep</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Neuron 1 Footprint&#39;</span><span class="p">);</span>
<span class="nb">colorbar</span><span class="p">;</span>

<span class="c">% Analyze spatial distribution of neurons</span>
<span class="nb">figure</span><span class="p">;</span>
<span class="nb">scatter</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">acx</span><span class="p">,</span><span class="w"> </span><span class="n">pm</span><span class="p">.</span><span class="n">acy</span><span class="p">);</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Spatial Distribution of Neurons&#39;</span><span class="p">);</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;x-coordinate&#39;</span><span class="p">);</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;y-coordinate&#39;</span><span class="p">);</span>

<span class="c">% Show correlation image</span>
<span class="nb">figure</span><span class="p">;</span>
<span class="nb">imagesc</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">Cn</span><span class="p">);</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Correlation Image&#39;</span><span class="p">);</span>
<span class="nb">colorbar</span><span class="p">;</span>

<span class="c">% Display mean image</span>
<span class="nb">figure</span><span class="p">;</span>
<span class="nb">imagesc</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">Ym</span><span class="p">);</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;Mean Image&#39;</span><span class="p">);</span>
<span class="nb">colorbar</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="registration.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Piecewise-Rigid Motion-Correction</p>
      </div>
    </a>
    <a class="right-next"
       href="offset_correction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Axial-Offset Correction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-extraction">Source Extraction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cnmf-options"><cite>cnmf_options</cite></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-thresh">merge_thresh</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#min-snr">min_SNR</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tau">Tau</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#p">P</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atoac">AtoAc</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#component-validation">Component Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deconvolution">Deconvolution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/segmentation.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Elizabeth R. Miller Brain Observatory (MBO) | The Rockefeller University. All Rights Reserved..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>